<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Verificación San Cristóbal</title>
  <link rel="stylesheet" href="estilos.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo institucional">
  <div class="fecha-reporte">Reporte: 18 de Enero de 2026</div>
</header>

<!-- ================= TABLA PRINCIPAL (NO TOCAR) ================= -->
<table id="tabla">
  <thead>
    <tr>
      <th>#</th>
      <th>Territorio</th>
      <th>Padrón 2024</th>
      <th>Ratificado</th>
      <th>Pendiente</th>
      <th>Verificados</th>
      <th>Nuevos</th>
      <th>Padrón 2025</th>
      <th>% Alcanzado con referencia al padrón original</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="bateria-container">
  <div class="bateria-label">% Avanzado del Pendiente</div>
  <div class="bateria">
    <div class="bateria-nivel" id="bateriaNivel"></div>
  </div>
  <div class="bateria-valor" id="bateriaValor">0.00%</div>
</div>

<!-- ================= NUEVA SECCIÓN PROVINCIAS ================= -->
<section class="provincias-section">
  <h2>Avance por Provincia (Comparativo Nacional)</h2>

  <table class="tabla-region unica">
    <thead>
      <tr>
        <th>Región</th>
        <th>Provincia</th>
        <th>Pendiente</th>
        <th>Verificados</th>
        <th>% Alcanzado</th>
      </tr>
    </thead>
    <tbody id="tabla-provincias"></tbody>
  </table>

  <canvas id="graficoProvincias" height="120"></canvas>
</section>

<script>
/* ================= CARGA TABLA PRINCIPAL + BATERÍA (NO TOCAR) ================= */
fetch('datos.csv?v=' + Date.now())
  .then(r => r.text())
  .then(text => {
    const filas = text.trim().split('\n').slice(1);
    const tbody = document.querySelector('#tabla tbody');

    filas.forEach(fila => {
      const c = fila.split(',');
      const tr = document.createElement('tr');
      if (c[0] === 'TOTAL') tr.classList.add('total');

      c.forEach((valor, i) => {
        const td = document.createElement('td');
        if (i === 1) td.classList.add('territorio');
        if (i === 5) td.classList.add('verificados');
        if (i === 6) td.classList.add('nuevos');

        if (i === 8) {
          const porcentaje = parseFloat(valor);
          const esTotal = c[0] === 'TOTAL';
          td.innerHTML = `
            <div class="barra-porcentaje ${esTotal ? 'barra-total' : ''}">
              <span style="width:${porcentaje.toFixed(2)}%"></span>
              <strong>${porcentaje.toFixed(2)}%</strong>
            </div>`;
        } else {
          td.textContent = valor;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    const filaTotal = filas.find(f => f.startsWith('TOTAL'));
    if (filaTotal) {
      const c = filaTotal.split(',');
      const totalPendiente = parseFloat(c[4]);
      const totalVerificados = parseFloat(c[5]);
      let porcentaje = (totalVerificados / totalPendiente) * 100;
      porcentaje = Math.max(0, Math.min(100, porcentaje));

      document.getElementById('bateriaNivel').style.width = porcentaje.toFixed(2) + '%';
      document.getElementById('bateriaValor').textContent = porcentaje.toFixed(2) + '%';
    }
  });

/* ================= NUEVA TABLA + GRÁFICO PROVINCIAS ================= */
fetch('datos2.csv?v=' + Date.now())
  .then(r => r.text())
  .then(text => {
    const filas = text.trim().split('\n').slice(1);
    const tbody = document.getElementById('tabla-provincias');

    const ordenRegiones = [
      'Ozama','Cibao Norte','Cibao Nordeste','Cibao Sur',
      'El Valle','Valdesia','Enriquillo','Yuma','Higuamo'
    ];

    const datos = filas.map(f => {
      const [region, provincia, pendiente, verificados, porcentaje] = f.split(',');
      return {
        region,
        provincia,
        pendiente: +pendiente,
        verificados: +verificados,
        porcentaje: +porcentaje
      };
    }).sort((a, b) =>
      ordenRegiones.indexOf(a.region) - ordenRegiones.indexOf(b.region)
    );

    datos.forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.region}</td>
        <td>${d.provincia}</td>
        <td>${d.pendiente}</td>
        <td>${d.verificados}</td>
        <td>
          <div class="barra-porcentaje barra-provincia">
            <span style="width:${Math.min(100,d.porcentaje)}%"></span>
            <strong>${d.porcentaje.toFixed(2)}%</strong>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    // ===== GRÁFICO =====
    const ctx = document.getElementById('graficoProvincias').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,400);
    grad.addColorStop(0,'#ff4d4d');
    grad.addColorStop(1,'#ffd966');

    new Chart(ctx,{
      type:'bar',
      data:{
        labels: datos.map(d=>d.provincia),
        datasets:[{
          data: datos.map(d=>d.porcentaje),
          backgroundColor: grad
        }]
      },
      options:{
        plugins:{legend:{display:false}},
        scales:{
          y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}
        }
      }
    });
  });
</script>

</body>
</html>
